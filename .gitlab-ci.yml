stages:
  - secret-detection
  - infra
  - deploy

variables:
  TF_ROOT: ${CI_PROJECT_DIR}/tofu
  TF_STATE_NAME: shdrch
  DOKKU_APP: shdrch

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - project: "aether/ci-templates"
    ref: main
    file:
      - "/dokku/tofu.yml"
      - "/dokku/deploy.yml"

secret_detection:
  stage: secret-detection

infra:
  extends:
    - .tofu_variables
    - .tofu_job
  stage: infra
  id_tokens:
    INFISICAL_AUTH_JWT:
      aud: https://infisical.home.shdr.ch
  script:
    - cd ${TF_ROOT}
    - tofu init
    - tofu apply -auto-approve
  only:
    - main

deploy:
  extends: .dokku_deploy
  stage: deploy
  only:
    - main

purge_cf_cache:
  stage: deploy
  needs: [deploy]
  image: curlimages/curl:latest
  script:
    - |
      response=$(curl -sf -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
        -H "Authorization: Bearer ${CF_API_TOKEN}" \
        -H "Content-Type: application/json" \
        --data '{"purge_everything":true}')
      echo "$response"
      echo "$response" | grep -q '"success": true'
  only:
    - main
